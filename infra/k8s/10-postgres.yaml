apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: nexus
type: Opaque
stringData:
  POSTGRES_DB: nexusdb
  POSTGRES_USER: nexus
  POSTGRES_PASSWORD: nexuspass
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: nexus
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  namespace: nexus
data:
  001_init.sql: |
    -- Roles/Users
    CREATE TABLE IF NOT EXISTS users (
      username TEXT PRIMARY KEY,
      password TEXT NOT NULL DEFAULT '',
      role     TEXT NOT NULL CHECK (role IN ('bodega','oficina','admin'))
    );

    -- Inventory (Lotes)
    CREATE TABLE IF NOT EXISTS inventory (
      id       SERIAL PRIMARY KEY,
      date     DATE NOT NULL,
      item     TEXT NOT NULL,
      category TEXT NOT NULL,
      type     TEXT NOT NULL,
      qty      INT  NOT NULL,
      status   TEXT NOT NULL DEFAULT 'AVAILABLE'
               CHECK (status IN ('AVAILABLE','RESERVED','SOLD')),
      username TEXT NOT NULL REFERENCES users(username),
      hash     TEXT NOT NULL DEFAULT 'PENDING'
    );

    -- Invoices (nacen desde un lote seleccionado)
    CREATE TABLE IF NOT EXISTS invoices (
      id          SERIAL PRIMARY KEY,
      inventory_id INT NOT NULL REFERENCES inventory(id),
      date        DATE NOT NULL,
      client      TEXT NOT NULL,
      total       NUMERIC(12,2) NOT NULL,
      status      TEXT NOT NULL DEFAULT 'PENDING_APPROVAL'
                  CHECK (status IN ('PENDING_APPROVAL','APPROVED','REJECTED')),
      username    TEXT NOT NULL REFERENCES users(username),
      hash        TEXT NOT NULL DEFAULT 'PENDING'
    );

    -- Ledger (blockchain simple) - CORREGIDO: incluye payload_json
    CREATE TABLE IF NOT EXISTS ledger (
      id          SERIAL PRIMARY KEY,
      ts          TIMESTAMPTZ NOT NULL,
      actor       TEXT NOT NULL,
      action      TEXT NOT NULL,
      tx_id       TEXT NOT NULL,
      prev_hash   TEXT NOT NULL,
      payload_json TEXT NOT NULL DEFAULT '{}',
      hash        TEXT NOT NULL
    );

    -- Seed users (password vacío por ahora)
    INSERT INTO users(username,password,role) VALUES
      ('bodega','', 'bodega'),
      ('oficina','', 'oficina'),
      ('admin','',  'admin')
    ON CONFLICT (username) DO NOTHING;

    -- Seed inventory (Lotes disponibles)
    INSERT INTO inventory(date,item,category,type,qty,status,username,hash) VALUES
      ('2023-10-24','Lote-CCN51-0001','Cacao CCN-51','Entrada',50,'AVAILABLE','bodega','PENDING'),
      ('2023-10-25','Lote-CCN51-0002','Cacao CCN-51','Entrada',12,'AVAILABLE','bodega','PENDING')
    ON CONFLICT DO NOTHING;

    -- Seed invoices (Pendientes de aprobación - nacen desde un lote)
    INSERT INTO invoices(inventory_id,date,client,total,status,username,hash) VALUES
      (1,'2023-10-26','Comprador Local',4500.00,'PENDING_APPROVAL','oficina','PENDING'),
      (2,'2023-10-27','Consumidor Final',120.50,'PENDING_APPROVAL','oficina','PENDING')
    ON CONFLICT DO NOTHING;

    -- Seed ledger (solo genesis, opcional)
    INSERT INTO ledger(ts,actor,action,tx_id,prev_hash,payload_json,hash) VALUES
      ('2023-10-24T08:30:00Z','system','INIT_GENESIS','TX_0000','0000000000000000','{}','INIT_HASH_GENESIS_BLOCK_SECURE')
    ON CONFLICT DO NOTHING;
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: nexus
  labels:
    app.kubernetes.io/name: nexus
    app.kubernetes.io/component: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: nexus
      app.kubernetes.io/component: postgres
  template:
    metadata:
      labels:
        app.kubernetes.io/name: nexus
        app.kubernetes.io/component: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:16-alpine
          ports:
            - containerPort: 5432
              name: pg
          env:
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_DB
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
          volumeMounts:
            - name: pgdata
              mountPath: /var/lib/postgresql/data
            - name: init
              mountPath: /docker-entrypoint-initdb.d
          readinessProbe:
            exec:
              command: ["sh","-lc","pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
            initialDelaySeconds: 8
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 6
          livenessProbe:
            exec:
              command: ["sh","-lc","pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
            initialDelaySeconds: 20
            periodSeconds: 20
            timeoutSeconds: 3
            failureThreshold: 6
      volumes:
        - name: pgdata
          persistentVolumeClaim:
            claimName: postgres-pvc
        - name: init
          configMap:
            name: postgres-init
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: nexus
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: nexus
    app.kubernetes.io/component: postgres
  ports:
    - name: pg
      port: 5432
      targetPort: 5432
